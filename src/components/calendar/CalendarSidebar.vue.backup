<template>
  <div class="h-full flex flex-col">
    <!-- View Switcher Buttons -->
    <div class="flex items-center gap-2 mb-4">
      <button
        v-for="view in views"
        :key="view.id"
        @click="currentView = view.id"
        :class="[
          'flex-1 flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl transition-all',
          currentView === view.id
            ? 'bg-blue-500/20 border-2 border-blue-500/50 text-blue-400'
            : 'bg-gray-800/40 border-2 border-white/5 text-gray-400 hover:bg-gray-800/60 hover:border-white/10',
        ]"
      >
        <component :is="view.icon" class="w-4 h-4" />
        <span class="text-xs font-semibold">{{ view.label }}</span>
      </button>
    </div>

    <!-- Content based on current view -->
    <div class="flex-1 overflow-y-auto custom-scrollbar">
      <!-- Calendar View -->
      <CalendarTab
        v-if="currentView === 'calendar'"
        :on-quick-action="handleQuickAction"
      />

      <!-- Event Creation View -->
      <EventTab
        v-else-if="currentView === 'event'"
        :on-event-created="handleEventCreated"
      />

      <!-- Legend/Filter View -->
      <LegendTab v-else-if="currentView === 'legend'" />
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from "vue";
import { useCalendarStore } from "@/stores/calendar";
import CalendarTab from "./sidebar/CalendarTab.vue";
import EventTab from "./sidebar/EventTab.vue";
import LegendTab from "./sidebar/LegendTab.vue";
import { Calendar, Plus, Filter } from "lucide-vue-next";
import type { ViewId } from "@/types/components";

const calendarStore = useCalendarStore();
const { goToToday, setViewMode } = calendarStore;

const currentView = ref<ViewId>("calendar");

const views = [
  { id: "calendar" as ViewId, label: "Calendar", icon: Calendar },
  { id: "event" as ViewId, label: "Event", icon: Plus },
  { id: "legend" as ViewId, label: "Legend", icon: Filter },
];

const handleQuickAction = (action: string): void => {
  switch (action) {
    case "today":
      goToToday();
      break;
    case "event":
      currentView.value = "event";
      break;
    case "week":
      const viewMode = calendarStore.viewMode;
      setViewMode(viewMode === "month" ? "week" : "month");
      break;
    case "refresh":
      location.reload();
      break;
  }
};

const handleEventCreated = (): void => {
  currentView.value = "calendar";
};
</script>

<style scoped>
.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.2);
}
</style>
        <div
          class="bg-linear-to-br from-blue-500/20 via-purple-500/20 to-pink-500/20 backdrop-blur-sm rounded-xl p-5 border border-white/10 shadow-lg"
        >
          <h3
            class="text-sm font-semibold text-white mb-4 flex items-center gap-2"
          >
            <Zap class="w-4 h-4 text-yellow-400" />
            Quick Actions
          </h3>

          <div class="grid grid-cols-2 gap-3">
            <button
              @click="handleQuickAction('today')"
              class="bg-gray-800/60 backdrop-blur-sm rounded-xl p-3 border border-white/10 hover:border-blue-500/50 hover:bg-gray-800/80 transition-all group"
            >
              <div class="flex flex-col items-center gap-2">
                <CalendarDays
                  class="w-5 h-5 text-blue-400 group-hover:text-blue-300 transition-colors"
                />
                <span
                  class="text-xs font-medium text-gray-300 group-hover:text-white transition-colors"
                >
                  Go to Today
                </span>
              </div>
            </button>

            <button
              @click="handleQuickAction('event')"
              class="bg-gray-800/60 backdrop-blur-sm rounded-xl p-3 border border-white/10 hover:border-green-500/50 hover:bg-gray-800/80 transition-all group"
            >
              <div class="flex flex-col items-center gap-2">
                <Plus
                  class="w-5 h-5 text-green-400 group-hover:text-green-300 transition-colors"
                />
                <span
                  class="text-xs font-medium text-gray-300 group-hover:text-white transition-colors"
                >
                  New Event
                </span>
              </div>
            </button>

            <button
              @click="handleQuickAction('week')"
              class="bg-gray-800/60 backdrop-blur-sm rounded-xl p-3 border border-white/10 hover:border-purple-500/50 hover:bg-gray-800/80 transition-all group"
            >
              <div class="flex flex-col items-center gap-2">
                <List
                  class="w-5 h-5 text-purple-400 group-hover:text-purple-300 transition-colors"
                />
                <span
                  class="text-xs font-medium text-gray-300 group-hover:text-white transition-colors"
                >
                  Week View
                </span>
              </div>
            </button>

            <button
              @click="handleQuickAction('refresh')"
              class="bg-gray-800/60 backdrop-blur-sm rounded-xl p-3 border border-white/10 hover:border-orange-500/50 hover:bg-gray-800/80 transition-all group"
            >
              <div class="flex flex-col items-center gap-2">
                <RefreshCw
                  class="w-5 h-5 text-orange-400 group-hover:text-orange-300 transition-colors"
                />
                <span
                  class="text-xs font-medium text-gray-300 group-hover:text-white transition-colors"
                >
                  Refresh
                </span>
              </div>
            </button>
          </div>
        </div>

        <!-- Calendar Statistics -->
        <div
          class="bg-gray-800/40 backdrop-blur-sm rounded-xl p-5 border border-white/10"
        >
          <h3
            class="text-sm font-semibold text-white mb-4 flex items-center gap-2"
          >
            <BarChart3 class="w-4 h-4 text-blue-400" />
            Calendar Overview
          </h3>

          <div class="space-y-3">
            <div
              class="flex items-center justify-between p-3 rounded-lg bg-linear-to-r from-blue-500/10 to-blue-500/5 border border-blue-500/20"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center"
                >
                  <Calendar class="w-5 h-5 text-blue-400" />
                </div>
                <div>
                  <p class="text-xs text-gray-400">Total Events</p>
                  <p class="text-lg font-bold text-white">
                    {{ totalEvents }}
                  </p>
                </div>
              </div>
            </div>

            <div
              class="flex items-center justify-between p-3 rounded-lg bg-linear-to-r from-green-500/10 to-green-500/5 border border-green-500/20"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center"
                >
                  <CalendarCheck class="w-5 h-5 text-green-400" />
                </div>
                <div>
                  <p class="text-xs text-gray-400">This Month</p>
                  <p class="text-lg font-bold text-white">
                    {{ eventsThisMonth }}
                  </p>
                </div>
              </div>
            </div>

            <div
              class="flex items-center justify-between p-3 rounded-lg bg-linear-to-r from-purple-500/10 to-purple-500/5 border border-purple-500/20"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center"
                >
                  <Clock class="w-5 h-5 text-purple-400" />
                </div>
                <div>
                  <p class="text-xs text-gray-400">Upcoming</p>
                  <p class="text-lg font-bold text-white">
                    {{ upcomingEvents }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- My Calendars Section -->
        <div
          class="bg-gray-800/40 backdrop-blur-sm rounded-xl p-5 border border-white/10"
        >
          <div class="flex items-center justify-between mb-4">
            <h3
              class="text-sm font-semibold text-white flex items-center gap-2"
            >
              <Layers class="w-4 h-4 text-blue-400" />
              My Calendars
            </h3>
            <button
              @click="toggleAllCalendars"
              class="text-xs text-blue-400 hover:text-blue-300 transition-colors font-medium"
            >
              {{ allCalendarsVisible ? "Hide All" : "Show All" }}
            </button>
          </div>

          <div class="space-y-2">
            <div
              v-for="calendar in calendars"
              :key="calendar.id"
              class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 transition-all cursor-pointer group border border-transparent hover:border-white/10"
              @click="toggleVisibility(calendar.id)"
            >
              <CustomCheckbox
                :model-value="calendar.visible"
                :color="calendar.color"
                :label="calendar.name"
                @update:model-value="toggleVisibility(calendar.id)"
              />
              <div class="ml-auto flex items-center gap-2">
                <span
                  class="text-xs text-gray-500 group-hover:text-gray-400 transition-colors"
                >
                  {{ getCalendarEventCount(calendar.id) }}
                </span>
                <ChevronRight
                  class="w-4 h-4 text-gray-600 group-hover:text-gray-400 transition-colors opacity-0 group-hover:opacity-100"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- View Options -->
        <div
          class="bg-gray-800/40 backdrop-blur-sm rounded-xl p-5 border border-white/10"
        >
          <h3
            class="text-sm font-semibold text-white mb-4 flex items-center gap-2"
          >
            <Settings class="w-4 h-4 text-blue-400" />
            View Settings
          </h3>

          <div class="space-y-3">
            <button
              @click="toggleViewMode"
              class="w-full flex items-center justify-between p-3 rounded-lg bg-gray-800/60 hover:bg-gray-800/80 transition-all border border-white/10 hover:border-white/20"
            >
              <div class="flex items-center gap-3">
                <component
                  :is="viewMode === 'month' ? CalendarDays : List"
                  class="w-4 h-4 text-blue-400"
                />
                <span class="text-sm text-gray-200">
                  {{ viewMode === "month" ? "Month View" : "Week View" }}
                </span>
              </div>
              <ArrowLeftRight class="w-4 h-4 text-gray-500" />
            </button>

            <button
              @click="toggleShowWeekends"
              class="w-full flex items-center justify-between p-3 rounded-lg bg-gray-800/60 hover:bg-gray-800/80 transition-all border border-white/10 hover:border-white/20"
            >
              <div class="flex items-center gap-3">
                <Sun class="w-4 h-4 text-yellow-400" />
                <span class="text-sm text-gray-200">Show Weekends</span>
              </div>
              <div
                :class="[
                  'w-10 h-6 rounded-full transition-all relative',
                  showWeekends ? 'bg-blue-500' : 'bg-gray-600',
                ]"
              >
                <div
                  :class="[
                    'absolute top-1 w-4 h-4 rounded-full bg-white transition-all',
                    showWeekends ? 'left-5' : 'left-1',
                  ]"
                />
              </div>
            </button>
          </div>
        </div>
      </div>

      <!-- Event Creation View -->
      <div v-else-if="currentView === 'event'" class="space-y-4">
        <div
          class="bg-gray-800/40 backdrop-blur-sm rounded-xl p-5 border border-white/10"
        >
          <h3
            class="text-sm font-semibold text-white mb-4 flex items-center gap-2"
          >
            <Plus class="w-4 h-4 text-blue-400" />
            New Event
          </h3>

          <form @submit.prevent="handleCreateEvent" class="space-y-4">
            <!-- Event Title -->
            <div>
              <label class="block text-xs font-medium text-gray-400 mb-2">
                Event Title
              </label>
              <input
                v-model="newEvent.title"
                type="text"
                placeholder="Enter event title"
                class="w-full bg-gray-800/60 backdrop-blur-sm rounded-xl px-4 py-3 border border-white/10 focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 transition-all outline-none text-sm text-gray-200 placeholder-gray-500"
              />
            </div>

            <!-- Date -->
            <div>
              <label class="block text-xs font-medium text-gray-400 mb-2">
                Date
              </label>
              <input
                v-model="newEvent.date"
                type="date"
                class="w-full bg-gray-800/60 backdrop-blur-sm rounded-xl px-4 py-3 border border-white/10 focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 transition-all outline-none text-sm text-gray-200"
              />
            </div>

            <!-- Weather Select -->
            <CircleSelect
              v-model="newEvent.weather"
              :options="weatherOptions"
              label="Weather"
              placeholder="Select weather"
            />

            <!-- Calendar Select -->
            <CircleSelect
              v-model="newEvent.calendar"
              :options="calendarOptions"
              label="Calendar"
              placeholder="Select calendar"
            />

            <!-- Dollar Amount -->
            <div>
              <label class="block text-xs font-medium text-gray-400 mb-2">
                Dollar Amount
              </label>
              <div class="relative">
                <div
                  class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"
                >
                  <DollarSign class="w-4 h-4" />
                </div>
                <input
                  v-model="newEvent.amount"
                  type="number"
                  step="0.01"
                  placeholder="0.00"
                  class="w-full bg-gray-800/60 backdrop-blur-sm rounded-xl pl-10 pr-4 py-3 border border-white/10 focus:border-green-500/50 focus:ring-2 focus:ring-green-500/20 transition-all outline-none text-sm text-gray-200 placeholder-gray-500"
                />
              </div>
            </div>

            <!-- Save Button -->
            <button
              type="submit"
              class="w-full bg-linear-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-all shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2"
            >
              <Save class="w-4 h-4" />
              Save Event
            </button>
          </form>
        </div>
      </div>

      <!-- Legend/Filter View -->
      <div v-else-if="currentView === 'legend'" class="space-y-4">
        <!-- Weather Legend -->
        <div
          class="bg-gray-800/40 backdrop-blur-sm rounded-xl p-5 border border-white/10"
        >
          <h3
            class="text-sm font-semibold text-white mb-4 flex items-center gap-2"
          >
            <Cloud class="w-4 h-4 text-blue-400" />
            Weather Legend
          </h3>

          <div class="space-y-3">
            <div
              v-for="weather in weatherOptions"
              :key="weather.value"
              class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors"
            >
              <div
                :class="[
                  'w-8 h-8 rounded-full flex items-center justify-center shrink-0',
                  weather.bgClass,
                ]"
              >
                <component
                  :is="weather.icon"
                  :class="['w-4 h-4', weather.iconClass]"
                />
              </div>
              <span class="text-sm font-medium text-gray-200">
                {{ weather.label }}
              </span>
            </div>
          </div>
        </div>

        <!-- Calendar Filters -->
        <div
          class="bg-gray-800/40 backdrop-blur-sm rounded-xl p-5 border border-white/10"
        >
          <h3
            class="text-sm font-semibold text-white mb-4 flex items-center gap-2"
          >
            <Filter class="w-4 h-4 text-blue-400" />
            Calendar Filters
          </h3>

          <div class="space-y-3">
            <div
              v-for="calendar in calendars"
              :key="calendar.id"
              class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors cursor-pointer"
              @click="toggleVisibility(calendar.id)"
            >
              <CustomCheckbox
                :model-value="calendar.visible"
                :color="calendar.color"
                :label="calendar.name"
                @update:model-value="toggleVisibility(calendar.id)"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from "vue";
import { storeToRefs } from "pinia";
import { useCalendarStore } from "@/stores/calendar";
import CustomCheckbox from "@/components/common/CustomCheckbox.vue";
import CircleSelect from "@/components/common/CircleSelect.vue";
import type {
  ViewId,
  WeatherOption,
  CalendarOption,
  NewEventForm,
} from "@/types/components";
import type { ColorType } from "@/types/calendar";
import {
  Calendar,
  Plus,
  Filter,
  Sun,
  Cloud,
  CloudRain,
  CloudSnow,
  CloudDrizzle,
  DollarSign,
  Save,
  Briefcase,
  User,
  Cake,
  CheckSquare,
  Zap,
  CalendarDays,
  List,
  RefreshCw,
  BarChart3,
  CalendarCheck,
  Clock,
  Layers,
  ChevronRight,
  Settings,
  ArrowLeftRight,
} from "lucide-vue-next";
import { startOfMonth, endOfMonth, isFuture, parseISO } from "date-fns";

const calendarStore = useCalendarStore();
const { calendars, viewMode } = storeToRefs(calendarStore);
const { toggleCalendarVisibility, addEvent, goToToday, setViewMode } =
  calendarStore;

const currentView = ref<ViewId>("calendar");
const showWeekends = ref<boolean>(true);

const views = [
  { id: "calendar" as ViewId, label: "Calendar", icon: Calendar },
  { id: "event" as ViewId, label: "Event", icon: Plus },
  { id: "legend" as ViewId, label: "Legend", icon: Filter },
];

// Computed properties for statistics
const totalEvents = computed((): number => {
  return calendarStore.events.length;
});

const eventsThisMonth = computed((): number => {
  const now = new Date();
  const monthStart = startOfMonth(now);
  const monthEnd = endOfMonth(now);

  return calendarStore.events.filter((event: any) => {
    const eventDate = parseISO(event.startDate);
    return eventDate >= monthStart && eventDate <= monthEnd;
  }).length;
});

const upcomingEvents = computed((): number => {
  const now = new Date();
  return calendarStore.events.filter((event: any) => {
    const eventDate = parseISO(event.startDate);
    return isFuture(eventDate);
  }).length;
});

const allCalendarsVisible = computed((): boolean => {
  return calendars.value.every((cal) => cal.visible);
});

// Helper function to get event count per calendar
const getCalendarEventCount = (calendarId: string): number => {
  const calendarName = calendars.value.find(
    (cal) => cal.id === calendarId
  )?.name;
  if (!calendarName) return 0;

  return calendarStore.events.filter(
    (event: any) => event.calendar === calendarName
  ).length;
};

// Quick action handlers
const handleQuickAction = (action: string): void => {
  switch (action) {
    case "today":
      goToToday();
      break;
    case "event":
      currentView.value = "event";
      break;
    case "week":
      setViewMode(viewMode.value === "month" ? "week" : "month");
      break;
    case "refresh":
      location.reload();
      break;
  }
};

const toggleAllCalendars = (): void => {
  const shouldHide = allCalendarsVisible.value;
  calendars.value.forEach((calendar) => {
    if (calendar.visible === !shouldHide) {
      toggleCalendarVisibility(calendar.id);
    }
  });
};

const toggleViewMode = (): void => {
  setViewMode(viewMode.value === "month" ? "week" : "month");
};

const toggleShowWeekends = (): void => {
  showWeekends.value = !showWeekends.value;
};

const weatherOptions: WeatherOption[] = [
  {
    value: "sunny",
    label: "Sunny",
    icon: Sun,
    iconClass: "text-yellow-400",
    bgClass: "bg-yellow-500/20",
  },
  {
    value: "cloudy",
    label: "Cloudy",
    icon: Cloud,
    iconClass: "text-gray-400",
    bgClass: "bg-gray-500/20",
  },
  {
    value: "rainy",
    label: "Rainy",
    icon: CloudRain,
    iconClass: "text-blue-400",
    bgClass: "bg-blue-500/20",
  },
  {
    value: "snowy",
    label: "Snowy",
    icon: CloudSnow,
    iconClass: "text-cyan-400",
    bgClass: "bg-cyan-500/20",
  },
  {
    value: "drizzle",
    label: "Drizzle",
    icon: CloudDrizzle,
    iconClass: "text-indigo-400",
    bgClass: "bg-indigo-500/20",
  },
];

const calendarOptions = computed<CalendarOption[]>(() => {
  const iconMap: Record<string, any> = {
    work: Briefcase,
    personal: User,
    birthdays: Cake,
    tasks: CheckSquare,
  };

  const colorMap: Record<ColorType, { iconClass: string; bgClass: string }> = {
    gray: { iconClass: "text-gray-400", bgClass: "bg-gray-500/20" },
    blue: { iconClass: "text-blue-400", bgClass: "bg-blue-500/20" },
    green: { iconClass: "text-green-400", bgClass: "bg-green-500/20" },
    red: { iconClass: "text-red-400", bgClass: "bg-red-500/20" },
    purple: { iconClass: "text-purple-400", bgClass: "bg-purple-500/20" },
    yellow: { iconClass: "text-yellow-400", bgClass: "bg-yellow-500/20" },
    orange: { iconClass: "text-orange-400", bgClass: "bg-orange-500/20" },
  };

  return calendars.value.map((cal: any) => ({
    value: cal.id,
    label: cal.name,
    icon: iconMap[cal.id] || Calendar,
    iconClass: colorMap[cal.color as ColorType]?.iconClass || "text-blue-400",
    bgClass: colorMap[cal.color as ColorType]?.bgClass || "bg-blue-500/20",
  }));
});

const newEvent = ref<NewEventForm>({
  title: "",
  date: new Date().toISOString().split("T")[0],
  weather: "sunny",
  calendar: "personal",
  amount: "",
});

const toggleVisibility = (calendarId: string): void => {
  toggleCalendarVisibility(calendarId);
};

const handleCreateEvent = (): void => {
  if (!newEvent.value.title.trim()) {
    return;
  }

  const eventData = {
    title: newEvent.value.title,
    startDate: `${newEvent.value.date}T00:00:00`,
    endDate: `${newEvent.value.date}T23:59:59`,
    calendar:
      calendars.value.find((c) => c.id === newEvent.value.calendar)?.name ||
      "Personal",
    color:
      (calendars.value.find((c) => c.id === newEvent.value.calendar)
        ?.color as ColorType) || "blue",
    weather: newEvent.value.weather as any,
    amount: newEvent.value.amount ? parseFloat(newEvent.value.amount) : null,
  };

  addEvent(eventData);

  newEvent.value = {
    title: "",
    date: new Date().toISOString().split("T")[0],
    weather: "sunny",
    calendar: "personal",
    amount: "",
  };

  currentView.value = "calendar";
};
</script>

<style scoped>
.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.2);
}
</style>
